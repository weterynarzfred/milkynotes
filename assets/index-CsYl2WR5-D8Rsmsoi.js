import{P as C,d as T,k as D,F as x,S,T as m,N as A,D as P,b as R,e as g,$ as L,f as v,g as N,M as h}from"./index-C0q07LRK.js";function B(s={}){return new C({view(e){return new E(e,s)}})}class E{constructor(e,r){var o;this.editorView=e,this.cursorPos=null,this.element=null,this.timeout=-1,this.width=(o=r.width)!==null&&o!==void 0?o:1,this.color=r.color===!1?void 0:r.color||"black",this.class=r.class,this.handlers=["dragover","dragend","drop","dragleave"].map(t=>{let i=n=>{this[t](n)};return e.dom.addEventListener(t,i),{name:t,handler:i}})}destroy(){this.handlers.forEach(({name:e,handler:r})=>this.editorView.dom.removeEventListener(e,r))}update(e,r){this.cursorPos!=null&&r.doc!=e.state.doc&&(this.cursorPos>e.state.doc.content.size?this.setCursor(null):this.updateOverlay())}setCursor(e){e!=this.cursorPos&&(this.cursorPos=e,e==null?(this.element.parentNode.removeChild(this.element),this.element=null):this.updateOverlay())}updateOverlay(){let e=this.editorView.state.doc.resolve(this.cursorPos),r=!e.parent.inlineContent,o;if(r){let l=e.nodeBefore,a=e.nodeAfter;if(l||a){let d=this.editorView.nodeDOM(this.cursorPos-(l?l.nodeSize:0));if(d){let u=d.getBoundingClientRect(),f=l?u.bottom:u.top;l&&a&&(f=(f+this.editorView.nodeDOM(this.cursorPos).getBoundingClientRect().top)/2),o={left:u.left,right:u.right,top:f-this.width/2,bottom:f+this.width/2}}}}if(!o){let l=this.editorView.coordsAtPos(this.cursorPos);o={left:l.left-this.width/2,right:l.left+this.width/2,top:l.top,bottom:l.bottom}}let t=this.editorView.dom.offsetParent;this.element||(this.element=t.appendChild(document.createElement("div")),this.class&&(this.element.className=this.class),this.element.style.cssText="position: absolute; z-index: 50; pointer-events: none;",this.color&&(this.element.style.backgroundColor=this.color)),this.element.classList.toggle("prosemirror-dropcursor-block",r),this.element.classList.toggle("prosemirror-dropcursor-inline",!r);let i,n;if(!t||t==document.body&&getComputedStyle(t).position=="static")i=-pageXOffset,n=-pageYOffset;else{let l=t.getBoundingClientRect();i=l.left-t.scrollLeft,n=l.top-t.scrollTop}this.element.style.left=o.left-i+"px",this.element.style.top=o.top-n+"px",this.element.style.width=o.right-o.left+"px",this.element.style.height=o.bottom-o.top+"px"}scheduleRemoval(e){clearTimeout(this.timeout),this.timeout=setTimeout(()=>this.setCursor(null),e)}dragover(e){if(!this.editorView.editable)return;let r=this.editorView.posAtCoords({left:e.clientX,top:e.clientY}),o=r&&r.inside>=0&&this.editorView.state.doc.nodeAt(r.inside),t=o&&o.type.spec.disableDropCursor,i=typeof t=="function"?t(this.editorView,r,e):t;if(r&&!i){let n=r.pos;if(this.editorView.dragging&&this.editorView.dragging.slice){let l=T(this.editorView.state.doc,n,this.editorView.dragging.slice);l!=null&&(n=l)}this.setCursor(n),this.scheduleRemoval(5e3)}}dragend(){this.scheduleRemoval(20)}drop(){this.scheduleRemoval(20)}dragleave(e){(e.target==this.editorView.dom||!this.editorView.dom.contains(e.relatedTarget))&&this.setCursor(null)}}class c extends g{constructor(e){super(e,e)}map(e,r){let o=e.resolve(r.map(this.head));return c.valid(o)?new c(o):g.near(o)}content(){return S.empty}eq(e){return e instanceof c&&e.head==this.head}toJSON(){return{type:"gapcursor",pos:this.head}}static fromJSON(e,r){if(typeof r.pos!="number")throw new RangeError("Invalid input for GapCursor.fromJSON");return new c(e.resolve(r.pos))}getBookmark(){return new w(this.anchor)}static valid(e){let r=e.parent;if(r.isTextblock||!z(e)||!F(e))return!1;let o=r.type.spec.allowGapCursor;if(o!=null)return o;let t=r.contentMatchAt(e.index()).defaultType;return t&&t.isTextblock}static findGapCursorFrom(e,r,o=!1){e:for(;;){if(!o&&c.valid(e))return e;let t=e.pos,i=null;for(let n=e.depth;;n--){let l=e.node(n);if(r>0?e.indexAfter(n)<l.childCount:e.index(n)>0){i=l.child(r>0?e.indexAfter(n):e.index(n)-1);break}else if(n==0)return null;t+=r;let a=e.doc.resolve(t);if(c.valid(a))return a}for(;;){let n=r>0?i.firstChild:i.lastChild;if(!n){if(i.isAtom&&!i.isText&&!A.isSelectable(i)){e=e.doc.resolve(t+i.nodeSize*r),o=!1;continue e}break}i=n,t+=r;let l=e.doc.resolve(t);if(c.valid(l))return l}return null}}}c.prototype.visible=!1;c.findFrom=c.findGapCursorFrom;g.jsonID("gapcursor",c);class w{constructor(e){this.pos=e}map(e){return new w(e.map(this.pos))}resolve(e){let r=e.resolve(this.pos);return c.valid(r)?new c(r):g.near(r)}}function z(s){for(let e=s.depth;e>=0;e--){let r=s.index(e),o=s.node(e);if(r==0){if(o.type.spec.isolating)return!0;continue}for(let t=o.child(r-1);;t=t.lastChild){if(t.childCount==0&&!t.inlineContent||t.isAtom||t.type.spec.isolating)return!0;if(t.inlineContent)return!1}}return!0}function F(s){for(let e=s.depth;e>=0;e--){let r=s.indexAfter(e),o=s.node(e);if(r==o.childCount){if(o.type.spec.isolating)return!0;continue}for(let t=o.child(r);;t=t.firstChild){if(t.childCount==0&&!t.inlineContent||t.isAtom||t.type.spec.isolating)return!0;if(t.inlineContent)return!1}}return!0}function K(){return new C({props:{decorations:J,createSelectionBetween(s,e,r){return e.pos==r.pos&&c.valid(r)?new c(r):null},handleClick:j,handleKeyDown:W,handleDOMEvents:{beforeinput:I}}})}const W=D({ArrowLeft:p("horiz",-1),ArrowRight:p("horiz",1),ArrowUp:p("vert",-1),ArrowDown:p("vert",1)});function p(s,e){const r=s=="vert"?e>0?"down":"up":e>0?"right":"left";return function(o,t,i){let n=o.selection,l=e>0?n.$to:n.$from,a=n.empty;if(n instanceof m){if(!i.endOfTextblock(r)||l.depth==0)return!1;a=!1,l=o.doc.resolve(e>0?l.after():l.before())}let d=c.findGapCursorFrom(l,e,a);return d?(t&&t(o.tr.setSelection(new c(d))),!0):!1}}function j(s,e,r){if(!s||!s.editable)return!1;let o=s.state.doc.resolve(e);if(!c.valid(o))return!1;let t=s.posAtCoords({left:r.clientX,top:r.clientY});return t&&t.inside>-1&&A.isSelectable(s.state.doc.nodeAt(t.inside))?!1:(s.dispatch(s.state.tr.setSelection(new c(o))),!0)}function I(s,e){if(e.inputType!="insertCompositionText"||!(s.state.selection instanceof c))return!1;let{$from:r}=s.state.selection,o=r.parent.contentMatchAt(r.index()).findWrapping(s.state.schema.nodes.text);if(!o)return!1;let t=x.empty;for(let n=o.length-1;n>=0;n--)t=x.from(o[n].createAndFill(null,t));let i=s.state.tr.replace(r.pos,r.pos,new S(t,0,0));return i.setSelection(m.near(i.doc.resolve(r.pos+1))),s.dispatch(i),!1}function J(s){if(!(s.selection instanceof c))return null;let e=document.createElement("div");return e.className="ProseMirror-gapcursor",P.create(s.doc,[R.widget(s.selection.head,e,{key:"gapcursor"})])}function b(s,e){return Object.assign(s,{meta:{package:"@milkdown/plugin-cursor",...e}}),s}const y=L({},"dropCursorConfig");b(y,{displayName:"Ctx<dropCursor>"});const O=v(s=>B(s.get(y.key)));b(O,{displayName:"Prose<dropCursor>"});const V=v(()=>K());b(V,{displayName:"Prose<gapCursor>"});const X=[y,O,V];function Y(s){var e;const r=(e=void 0)!=null?e:!1;let o=typeof document>"u"?null:document.createElement("div");return new C({key:q,view:t=>{r!==!0&&G(t.state.schema,r||[]);const i=t.dom.ownerDocument;o=o||document.createElement("div");const n=o,l=()=>{U(t,n)};let a;return window.ResizeObserver&&(a=new window.ResizeObserver(()=>l()),a.observe(t.dom)),i.addEventListener("selectionchange",l),{update:()=>{l()},destroy:()=>{i.removeEventListener("selectionchange",l),a&&a.unobserve(t.dom)}}},props:{handleKeyDown:(t,i)=>{var n;const{selection:l}=t.state;if(i.altKey||i.ctrlKey||i.metaKey||i.shiftKey||i.isComposing||!["ArrowLeft","ArrowRight"].includes(i.key)||!k(l)||!l.empty)return!1;const a=l.$head,[d,u]=M(a),f=t.state.storedMarks||a.marks();if(d&&u&&!h.sameSet(d,u)){if(i.key==="ArrowLeft"&&!h.sameSet(d,f))return t.dispatch(t.state.tr.setStoredMarks(d)),!0;if(i.key==="ArrowRight"&&!h.sameSet(u,f))return t.dispatch(t.state.tr.setStoredMarks(u)),!0}return i.key==="ArrowLeft"&&a.textOffset===1?(t.dispatch(t.state.tr.setSelection(m.create(t.state.doc,a.pos-1)).setStoredMarks(a.marks())),!0):i.key==="ArrowRight"&&a.textOffset+1===((n=a.parent.maybeChild(a.index()))==null?void 0:n.nodeSize)?(t.dispatch(t.state.tr.setSelection(m.create(t.state.doc,a.pos+1)).setStoredMarks(a.marks())),!0):!1},decorations:t=>{if(!(!o||!k(t.selection)||!t.selection.empty))return P.create(t.doc,[R.widget(0,o,{key:"prosemirror-virtual-cursor"})])},attributes:{class:"virtual-cursor-enabled"}}})}var q=new N("prosemirror-virtual-cursor");function H(s,e){var r;const o=window.getSelection();if(!o||!o.rangeCount)return null;const t=(r=o==null?void 0:o.getRangeAt(0))==null?void 0:r.cloneRange();if(!t)return null;t.collapse(e);const i=t.getClientRects(),n=i!=null&&i.length?i[i.length-1]:null;return n!=null&&n.height?n:s.coordsAtPos(s.state.selection.head)}function M(s){const e=s.index(),r=s.parent.maybeChild(e);let o=s.textOffset?r:null;return!o&&e>0&&(o=s.parent.maybeChild(e-1)),[o==null?void 0:o.marks,r==null?void 0:r.marks]}function k(s){return s&&typeof s=="object"&&"$cursor"in s}function U(s,e){if(!s||!s.dom||s.isDestroyed||!e)return;const{state:r,dom:o}=s,{selection:t}=r;if(!k(t))return;const i=H(s,t.$head===t.$from);if(!i)return e;const n=o.getBoundingClientRect();let l="prosemirror-virtual-cursor";const a=r.selection.$head,[d,u]=M(a),f=r.storedMarks||a.marks();t.$cursor&&d&&u&&f&&!h.sameSet(d,u)&&(h.sameSet(d,f)?l+=" prosemirror-virtual-cursor-left":h.sameSet(u,f)&&(l+=" prosemirror-virtual-cursor-right")),e.className=l,$(e,"prosemirror-virtual-cursor-animation"),e.style.height=`${i.bottom-i.top}px`,e.style.left=`${i.left-n.left}px`,e.style.top=`${i.top-n.top}px`}function $(s,e){s.classList.remove(e),s.offsetWidth,s.classList.add(e)}function G(s,e){for(const[r,o]of Object.entries(s.marks))o.spec.inclusive===!1&&!e.includes(r)&&console.warn(`[prosemirror-virtual-cursor] Virtual cursor does not work well with marks that have inclusive set to false. Please consider removing the inclusive option from the "${r}" mark or adding it to the "skipWarning" option.`)}const Z=(s,e)=>{if(s.config(o=>{o.update(y.key,()=>{var t,i;return{class:"crepe-drop-cursor",width:(t=e==null?void 0:e.width)!=null?t:4,color:(i=e==null?void 0:e.color)!=null?i:!1}})}).use(X),(e==null?void 0:e.virtual)===!1)return;const r=Y();s.use(v(()=>r))};export{Z as defineFeature};
