import{m as D,k as Z,a as J}from"./inline-latex-C9IGAXXQ-Dz3ezYpm.js";import{a8 as E,a9 as K,aa as S,ab as F,r as Q,C as j,A as O,ac as A,x as B,ad as tt,ae as et,G as nt,N as at,af as rt,ag as it,ah as ot,ai as ut,aj as L,ak as lt}from"./index-CrKDOvK2.js";import{d as st}from"./index-D6fLMv29-COUJrQhB.js";import{l as ht,b as ct,T as mt,h as dt}from"./functions-Bsik6ikd-Dr945oKc.js";import{O as pt}from"./index.es-y3KVJQnX.js";import{t as xt,T as wt}from"./index.es-XyH-Eo0m.js";import"./hooks-DzxriSVi.js";import"./floating-ui.dom-DJfcjnnZ.js";import"./index-CD0Q-Ibi.js";function ft(){return{enter:{mathFlow:t,mathFlowFenceMeta:e,mathText:l},exit:{mathFlow:n,mathFlowFence:r,mathFlowFenceMeta:a,mathFlowValue:h,mathText:s,mathTextData:h}};function t(o){const c={type:"element",tagName:"code",properties:{className:["language-math","math-display"]},children:[]};this.enter({type:"math",meta:null,value:"",data:{hName:"pre",hChildren:[c]}},o)}function e(){this.buffer()}function a(){const o=this.resume(),c=this.stack[this.stack.length-1];E(c.type==="math"),c.meta=o}function r(){this.data.mathFlowInside||(this.buffer(),this.data.mathFlowInside=!0)}function n(o){const c=this.resume().replace(/^(\r?\n|\r)|(\r?\n|\r)$/g,""),m=this.stack[this.stack.length-1];E(m.type==="math"),this.exit(o),m.value=c;const p=m.data.hChildren[0];E(p.type==="element"),E(p.tagName==="code"),p.children.push({type:"text",value:c}),this.data.mathFlowInside=void 0}function l(o){this.enter({type:"inlineMath",value:"",data:{hName:"code",hProperties:{className:["language-math","math-inline"]},hChildren:[]}},o),this.buffer()}function s(o){const c=this.resume(),m=this.stack[this.stack.length-1];E(m.type==="inlineMath"),this.exit(o),m.value=c,m.data.hChildren.push({type:"text",value:c})}function h(o){this.config.enter.data.call(this,o),this.config.exit.data.call(this,o)}}function kt(t){let e=(t||{}).singleDollarTextMath;return e==null&&(e=!0),r.peek=n,{unsafe:[{character:"\r",inConstruct:"mathFlowMeta"},{character:`
`,inConstruct:"mathFlowMeta"},{character:"$",after:e?void 0:"\\$",inConstruct:"phrasing"},{character:"$",inConstruct:"mathFlowMeta"},{atBreak:!0,character:"$",after:"\\$"}],handlers:{math:a,inlineMath:r}};function a(l,s,h,o){const c=l.value||"",m=h.createTracker(o),p="$".repeat(Math.max(K(c,"$")+1,2)),x=h.enter("mathFlow");let d=m.move(p);if(l.meta){const w=h.enter("mathFlowMeta");d+=m.move(h.safe(l.meta,{after:`
`,before:d,encode:["$"],...m.current()})),w()}return d+=m.move(`
`),c&&(d+=m.move(c+`
`)),d+=m.move(p),x(),d}function r(l,s,h){let o=l.value||"",c=1;for(e||c++;new RegExp("(^|[^$])"+"\\$".repeat(c)+"([^$]|$)").test(o);)c++;const m="$".repeat(c);/[^ \r\n]/.test(o)&&(/^[ \r\n]/.test(o)&&/[ \r\n]$/.test(o)||/^\$|\$$/.test(o))&&(o=" "+o+" ");let p=-1;for(;++p<h.unsafe.length;){const x=h.unsafe[p];if(!x.atBreak)continue;const d=h.compilePattern(x);let w;for(;w=d.exec(o);){let u=w.index;o.codePointAt(u)===10&&o.codePointAt(u-1)===13&&u--,o=o.slice(0,u)+" "+o.slice(w.index+1)}}return m+o+m}function n(){return"$"}}const gt={tokenize:Mt,concrete:!0,name:"mathFlow"},N={tokenize:Ft,partial:!0};function Mt(t,e,a){const r=this,n=r.events[r.events.length-1],l=n&&n[1].type==="linePrefix"?n[2].sliceSerialize(n[1],!0).length:0;let s=0;return h;function h(i){return t.enter("mathFlow"),t.enter("mathFlowFence"),t.enter("mathFlowFenceSequence"),o(i)}function o(i){return i===36?(t.consume(i),s++,o):s<2?a(i):(t.exit("mathFlowFenceSequence"),S(t,c,"whitespace")(i))}function c(i){return i===null||F(i)?p(i):(t.enter("mathFlowFenceMeta"),t.enter("chunkString",{contentType:"string"}),m(i))}function m(i){return i===null||F(i)?(t.exit("chunkString"),t.exit("mathFlowFenceMeta"),p(i)):i===36?a(i):(t.consume(i),m)}function p(i){return t.exit("mathFlowFence"),r.interrupt?e(i):t.attempt(N,x,C)(i)}function x(i){return t.attempt({tokenize:G,partial:!0},C,d)(i)}function d(i){return(l?S(t,w,"linePrefix",l+1):w)(i)}function w(i){return i===null?C(i):F(i)?t.attempt(N,x,C)(i):(t.enter("mathFlowValue"),u(i))}function u(i){return i===null||F(i)?(t.exit("mathFlowValue"),w(i)):(t.consume(i),u)}function C(i){return t.exit("mathFlow"),e(i)}function G(i,H,z){let I=0;return S(i,U,"linePrefix",r.parser.constructs.disable.null.includes("codeIndented")?void 0:4);function U(k){return i.enter("mathFlowFence"),i.enter("mathFlowFenceSequence"),q(k)}function q(k){return k===36?(I++,i.consume(k),q):I<s?z(k):(i.exit("mathFlowFenceSequence"),S(i,Y,"whitespace")(k))}function Y(k){return k===null||F(k)?(i.exit("mathFlowFence"),H(k)):z(k)}}}function Ft(t,e,a){const r=this;return n;function n(s){return s===null?e(s):(t.enter("lineEnding"),t.consume(s),t.exit("lineEnding"),l)}function l(s){return r.parser.lazy[r.now().line]?a(s):e(s)}}function yt(t){let a=(t||{}).singleDollarTextMath;return a==null&&(a=!0),{tokenize:r,resolve:vt,previous:Et,name:"mathText"};function r(n,l,s){let h=0,o,c;return m;function m(u){return n.enter("mathText"),n.enter("mathTextSequence"),p(u)}function p(u){return u===36?(n.consume(u),h++,p):h<2&&!a?s(u):(n.exit("mathTextSequence"),x(u))}function x(u){return u===null?s(u):u===36?(c=n.enter("mathTextSequence"),o=0,w(u)):u===32?(n.enter("space"),n.consume(u),n.exit("space"),x):F(u)?(n.enter("lineEnding"),n.consume(u),n.exit("lineEnding"),x):(n.enter("mathTextData"),d(u))}function d(u){return u===null||u===32||u===36||F(u)?(n.exit("mathTextData"),x(u)):(n.consume(u),d)}function w(u){return u===36?(n.consume(u),o++,w):o===h?(n.exit("mathTextSequence"),n.exit("mathText"),l(u)):(c.type="mathTextData",d(u))}}}function vt(t){let e=t.length-4,a=3,r,n;if((t[a][1].type==="lineEnding"||t[a][1].type==="space")&&(t[e][1].type==="lineEnding"||t[e][1].type==="space")){for(r=a;++r<e;)if(t[r][1].type==="mathTextData"){t[e][1].type="mathTextPadding",t[a][1].type="mathTextPadding",a+=2,e-=2;break}}for(r=a-1,e++;++r<=e;)n===void 0?r!==e&&t[r][1].type!=="lineEnding"&&(n=r):(r===e||t[r][1].type==="lineEnding")&&(t[n][1].type="mathTextData",r!==n+2&&(t[n][1].end=t[r-1][1].end,t.splice(n+2,r-n-2),e-=r-n-2,r=n+2),n=void 0);return t}function Et(t){return t!==36||this.events[this.events.length-1][1].type==="characterEscape"}function Tt(t){return{flow:{36:gt},text:{36:yt(t)}}}const Ct={};function St(t){const e=this,a=t||Ct,r=e.data(),n=r.micromarkExtensions||(r.micromarkExtensions=[]),l=r.fromMarkdownExtensions||(r.fromMarkdownExtensions=[]),s=r.toMarkdownExtensions||(r.toMarkdownExtensions=[]);n.push(Tt(a)),l.push(ft()),s.push(kt(a))}const $t=O("remarkMath",()=>St);function _t(t){return nt(t,"math",(e,a,r)=>{const{value:n}=e,l={type:"code",lang:"LaTeX",value:n};r.children.splice(a,1,l)})}const bt=O("remarkMathBlock",()=>()=>_t),V=({config:t,innerView:e,updateValue:a})=>{var r;const n=l=>{l.preventDefault(),a==null||a()};return dt`
    <host>
      <div class="container">
        ${e&&mt(e.dom,{})}
        <button onmousedown=${n}>
          ${(r=t==null?void 0:t.inlineEditConfirm)==null?void 0:r.call(t)}
        </button>
      </div>
    </host>
  `};V.props={config:Object,innerView:Object,updateValue:Function};const W=ct(V),P=xt("INLINE_LATEX");var R=t=>{throw TypeError(t)},X=(t,e,a)=>e.has(t)||R("Cannot "+a),f=(t,e,a)=>(X(t,e,"read from private field"),a?a.call(t):e.get(t)),y=(t,e,a)=>e.has(t)?R("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,a),T=(t,e,a,r)=>(X(t,e,"write to private field"),e.set(t,a),a),g,v,$,M,_,b;class zt{constructor(e,a,r){this.ctx=e,y(this,g,new W),y(this,v),y(this,$),y(this,M),y(this,_,()=>{f(this,M)&&(f(this,M).destroy(),T(this,M,null))}),y(this,b,n=>{const s=(()=>{const{selection:h,schema:o}=n.state;if(h.empty||!(h instanceof at))return!1;const c=h.node;if(c.type.name!==J)return!1;const m=h.from,p=o.nodes.paragraph.create(null,o.text(c.attrs.value)),x=new rt(f(this,$),{state:it.create({doc:p,schema:new ut({nodes:{doc:{content:"block+"},paragraph:{content:"inline*",group:"block",parseDOM:[{tag:"p"}],toDOM(){return["p",0]}},text:{group:"inline"}}}),plugins:[ot({"Mod-z":lt,"Mod-Z":L,"Mod-y":L,Enter:()=>{var d,w;return(w=(d=f(this,g)).updateValue)==null||w.call(d),!0}})]})});return T(this,M,x),f(this,g).innerView=f(this,M),f(this,g).updateValue=()=>{const{tr:d}=n.state;d.setNodeAttribute(m,"value",x.state.doc.textContent),n.dispatch(d),requestAnimationFrame(()=>{n.focus()})},!0})();return s||f(this,_).call(this),s}),this.update=(n,l)=>{f(this,v).update(n,l)},this.destroy=()=>{f(this,v).destroy(),f(this,g).remove()},T(this,v,new wt({debounce:0,content:f(this,g),shouldShow:f(this,b),offset:10,floatingUIOptions:{placement:"bottom"}})),f(this,g).config=r,f(this,v).update(a),T(this,$,document.createElement("div")),T(this,M,null)}}g=new WeakMap;v=new WeakMap;$=new WeakMap;M=new WeakMap;_=new WeakMap;b=new WeakMap;const It=A(t=>tt(/(?:\$)([^$]+)(?:\$)$/,D.type(t),{getAttr:e=>{var a;return{value:(a=e[1])!=null?a:""}}})),qt=A(t=>et(/^\$\$[\s\n]$/,B.type(t),()=>({language:"LaTeX"}))),Lt=B.extendSchema(t=>e=>{const a=t(e);return{...a,toMarkdown:{match:a.toMarkdown.match,runner:(r,n)=>{var l,s;if(((l=n.attrs.language)!=null?l:"").toLowerCase()==="latex")r.addNode("math",void 0,((s=n.content.firstChild)==null?void 0:s.text)||"");else return a.toMarkdown.runner(r,n)}}}});st("milkdown-latex-inline-edit",W);const Gt=(t,e)=>{t.config(a=>{if(!a.get(Q).includes(j.CodeMirror))throw new Error("You need to enable CodeMirror to use LaTeX feature");a.update(pt.key,l=>({...l,renderPreview:(s,h)=>{if(s.toLowerCase()==="latex"&&h.length>0)return Nt(h,e==null?void 0:e.katexOptions);const o=l.renderPreview;return o(s,h)}})),a.set(P.key,{view:l=>{var s;return new zt(a,l,{inlineEditConfirm:(s=e==null?void 0:e.inlineEditConfirm)!=null?s:()=>ht,...e})}})}).use($t).use(bt).use(D).use(P).use(It).use(qt).use(Lt)};function Nt(t,e){return Z.renderToString(t,{...e,throwOnError:!1,displayMode:!0})}export{Gt as defineFeature};
